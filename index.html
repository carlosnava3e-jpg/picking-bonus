<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>æ‹£è´§å¥–é‡‘è®¡ç®—å™¨ / Calculadora de Bonos</title>

  <meta name="theme-color" content="#2b6cb0"/>
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icons/icon-192.png" />

  <!-- ç®€å•æ ·å¼ï¼Œç§»åŠ¨ä¼˜å…ˆ -->
  <style>
    :root{
      --primary:#2b6cb0;
      --accent:#2b7a4b;
      --muted:#6b7280;
      --card-bg:#fff;
      --bg:#f5f7fa;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    header{padding:14px 16px;background:var(--primary);color:white;display:flex;align-items:center;gap:12px;}
    header h1{margin:0;font-size:16px;font-weight:600;}
    .wrap{padding:12px;max-width:980px;margin:0 auto;}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
    .controls > *{flex:1 1 160px;min-width:120px;}
    input[type="date"], input[type="text"], input[type="number"], select{
      width:100%; padding:10px;border-radius:8px;border:1px solid #ddd; box-sizing:border-box;font-size:15px;
    }
    button{background:var(--accent);color:white;border:none;padding:10px 12px;border-radius:10px;font-weight:600;cursor:pointer;}
    button.secondary{background:#6b7280;}
    .cards{display:flex;flex-direction:column;gap:12px;}
    .card{background:var(--card-bg);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);}
    .row{display:flex;gap:8px;flex-wrap:wrap;}
    .col{flex:1 1 120px;min-width:110px;}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
    .summary{margin-top:12px;background:#eef2ff;padding:10px;border-radius:10px;font-size:14px;white-space:pre-line;}
    .small{font-size:13px;color:var(--muted);}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
    .deleteBtn{background:#e53e3e;}
    footer{padding:12px;text-align:center;font-size:13px;color:var(--muted);}
    /* make inputs easier to tap on iOS */
    input, select, button { -webkit-tap-highlight-color: rgba(0,0,0,0.05); -webkit-appearance:none; }
    @media(min-width:720px){ .row{flex-wrap:nowrap;} .col{min-width:150px;} }
  </style>
</head>
<body>
  <header>
    <img src="/icons/icon-96.png" alt="" width="36" height="36" style="border-radius:8px;background:white;padding:4px"/>
    <h1>æ‹£è´§å¥–é‡‘è®¡ç®—å™¨ <small class="small">/ Calculadora de Bonos</small></h1>
  </header>

  <main class="wrap">
    <!-- å‘¨å¼€å§‹æ—¥æœŸ -->
    <div class="controls" aria-hidden="false">
      <div>
        <label>å‘¨å¼€å§‹æ—¥æœŸ / Fecha inicio de la semana</label>
        <input type="date" id="weekStart" />
        <div class="small" id="weekRange" style="margin-top:6px">Semana: â€”</div>
      </div>

      <div>
        <label>å¢åŠ å‘˜å·¥ / Agregar empleado</label>
        <button id="addBtn">â• æ·»åŠ å‘˜å·¥</button>
      </div>

      <div>
        <label>æ“ä½œ / Acciones</label>
        <div style="display:flex;gap:8px;">
          <button id="calcBtn">ğŸ’° è®¡ç®—å¥–é‡‘</button>
          <button id="exportBtn" class="secondary">ğŸ“¤ å¯¼å‡º Excel</button>
        </div>
      </div>
    </div>

    <!-- å¡ç‰‡åˆ—è¡¨ -->
    <section id="cards" class="cards" aria-live="polite"></section>

    <!-- ç»Ÿè®¡ -->
    <div id="summary" class="summary">
      <div id="summaryText">å°šæœªè®¡ç®— / No calculado</div>
    </div>
  </main>

  <footer>ç¦»çº¿å¯ç”¨ Â· æ”¯æŒå®‰è£…åˆ°ä¸»å±å¹• Â· Datos guardados localmente</footer>

  <!-- ç¬¬ä¸‰æ–¹ä¾èµ–ï¼šxlsx -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <script defer>
  // ========== æ•°æ®æ¨¡å‹ ==========
  const STORAGE_KEY = 'picking_bonos_v1';
  let employees = []; // æ¯ä½å‘˜å·¥å¯¹è±¡ {id,name,day1..day6, noError(bool), teamExtra(bool)}

  // helpers
  const $ = sel => document.querySelector(sel);
  const uid = () => 'e' + Math.random().toString(36).slice(2,9);

  // åˆå§‹åŒ–ï¼šè¯»å–ç¼“å­˜
  function loadData(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw) employees = JSON.parse(raw);
      else employees = [];
    }catch(e){ employees = []; }
  }
  function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(employees)); }

  // UIï¼šæ¸²æŸ“æ¯ä¸ªå‘˜å·¥å¡ç‰‡ï¼ˆå¡ç‰‡å¼ï¼Œæ‰‹æœºå‹å¥½ï¼‰
  function render(){
    const container = $('#cards');
    container.innerHTML = '';
    if(employees.length === 0) {
      // æ–°ç”¨æˆ·ç»™ä¸€è¡Œç¤ºä¾‹
      employees.push({
        id: uid(), name: '', days: [0,0,0,0,0,0], noError:true, teamExtra:false
      });
    }
    employees.forEach(emp => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="row" style="align-items:center;">
          <div class="col" style="flex:1 1 45%;">
            <label>å§“å / Nombre</label>
            <input type="text" class="emp-name" value="${escapeHtml(emp.name)}" placeholder="ä¾‹å¦‚: Juan / å°ç‹">
          </div>
          <div class="col" style="min-width:120px;">
            <label>æ— é”™è¯¯ / Sin errores</label>
            <select class="emp-noerror">
              <option value="true" ${emp.noError ? 'selected':''}>æ˜¯ / SÃ­</option>
              <option value="false" ${!emp.noError ? 'selected':''}>å¦ / No</option>
            </select>
          </div>
        </div>

        <div style="margin-top:8px;color:var(--muted);font-weight:600;">æ¯æ—¥æ‹£è´§ç®±æ•°ï¼ˆå‘¨ä¸€~å‘¨å…­ï¼‰/ Cajas por dÃ­a (Lun~SÃ¡b)</div>
        <div class="row" style="margin-top:6px;">
          ${[0,1,2,3,4,5].map(i => `
            <div class="col">
              <label class="small">ç¬¬${i+1}å¤© / DÃ­a ${i+1}</label>
              <input type="number" class="emp-day" data-index="${i}" value="${emp.days[i]||0}" min="0" />
            </div>
          `).join('')}
        </div>

        <div class="row" style="margin-top:8px;">
          <div class="col">
            <label>å›¢é˜Ÿ+10% å¥–åŠ± / Equipo +10%</label>
            <select class="emp-teamextra">
              <option value="false" ${!emp.teamExtra ? 'selected':''}>å¦ / No</option>
              <option value="true" ${emp.teamExtra ? 'selected':''}>æ˜¯ / SÃ­</option>
            </select>
          </div>

          <div class="col" style="display:flex;flex-direction:column;justify-content:flex-end;">
            <div style="display:flex;gap:8px;">
              <button class="calcOneBtn">è®¡ç®—æœ¬å‘¨å¥–é‡‘</button>
              <button class="deleteBtn" style="background:#e53e3e;color:white">åˆ é™¤</button>
            </div>
            <div style="margin-top:8px;color:var(--muted);font-size:14px;">
              å½“å‰å¥–é‡‘ / Bono: <span class="emp-bono">$0.00</span>
            </div>
          </div>
        </div>
      `;

      // ç»‘å®šäº‹ä»¶ AFTER æ’å…¥åˆ° DOMï¼ˆiOS ç‚¹å‡»æ›´ç¨³å®šï¼‰
      container.appendChild(div);

      // references
      const nameEl = div.querySelector('.emp-name');
      const dayEls = div.querySelectorAll('.emp-day');
      const noErrEl = div.querySelector('.emp-noerror');
      const teamExtraEl = div.querySelector('.emp-teamextra');
      const calcOne = div.querySelector('.calcOneBtn');
      const deleteBtn = div.querySelector('.deleteBtn');
      const bonoEl = div.querySelector('.emp-bono');

      // sync from UI to model
      nameEl.addEventListener('input', e => { emp.name = e.target.value; saveData(); });
      noErrEl.addEventListener('change', e => { emp.noError = e.target.value === 'true'; saveData(); });
      teamExtraEl.addEventListener('change', e => { emp.teamExtra = e.target.value === 'true'; saveData(); });

      dayEls.forEach(d => {
        d.addEventListener('input', e => {
          const idx = Number(e.target.dataset.index);
          emp.days[idx] = Number(e.target.value) || 0;
          saveData();
        });
      });

      calcOne.addEventListener('click', () => {
        const b = calcEmployeeBono(emp);
        bonoEl.innerText = formatMoney(b);
        updateSummary(); // update global
      });

      deleteBtn.addEventListener('click', () => {
        employees = employees.filter(x => x.id !== emp.id);
        saveData();
        render();
      });
    });

    updateWeekDisplay();
    updateSummary();
  }

  // è®¡ç®—å•ä¸ªå‘˜å·¥æœ¬å‘¨å¥–é‡‘ï¼ˆè§„åˆ™ï¼šæ¯æ—¥æŒ‰é˜¶æ¢¯è®¡ç®—å†æ±‚å’Œï¼›å‘¨å†…æ— é”™è¯¯ +100ï¼›å›¢é˜Ÿ+10% +150ï¼‰
  function calcEmployeeBono(emp){
    let total = 0;
    for(let d of emp.days){
      total += calcDailyBonus(d);
    }
    if(emp.noError) total += 100;
    if(emp.teamExtra) total += 150;
    return Math.round(total*100)/100;
  }

  function calcDailyBonus(cajas){
    let b = 0;
    if(cajas > 400 && cajas <= 500) b += (cajas - 400) * 0.10;
    else if(cajas > 500 && cajas <= 600) b += 100 * 0.10 + (cajas - 500) * 0.20;
    else if(cajas > 600) b += 100 * 0.10 + 100 * 0.20 + (cajas - 600) * 0.30;
    return b;
  }

  function formatMoney(n){ return '$' + Number(n).toFixed(2); }

  // è®¡ç®—å¹¶æ˜¾ç¤ºæ€»è¡¨ä¸æ’å
  function updateSummary(){
    const summaryEl = $('#summaryText') || document.getElementById('summaryText');
    let total = 0;
    const rows = employees.map(emp => {
      const b = calcEmployeeBono(emp);
      total += b;
      return { name: emp.name || 'Empleado', bono: b, avg: emp.days.reduce((s,x)=>s+x,0)/emp.days.length };
    });
    rows.sort((a,b)=>b.bono - a.bono);

    let txt = `æ€»å¥–é‡‘ / Total general: ${formatMoney(total)}\n\nğŸ† æ’å / Ranking:\n`;
    rows.forEach((r,i)=> txt += `${i+1}. ${r.name} â€” ${formatMoney(r.bono)} (å¹³å‡ ${Math.round(r.avg*10)/10})\n`);
    summaryEl.innerText = txt;
  }

  // å‘¨å¼€å§‹/ç»“æŸæ˜¾ç¤º
  function updateWeekDisplay(){
    const inp = document.getElementById('weekStart');
    const range = document.getElementById('weekRange');
    const dstr = inp.value;
    if(!dstr){ range.innerText = 'Semana: â€”'; return; }
    try{
      const start = new Date(dstr);
      const end = new Date(start);
      end.setDate(start.getDate() + 5); // Mon ~ Sat
      range.innerText = `Semana: ${start.toISOString().slice(0,10)} ~ ${end.toISOString().slice(0,10)}`;
      // save chosen week to localStorage
      localStorage.setItem('picking_week', dstr);
    }catch(e){ range.innerText = 'Semana: â€”'; }
  }

  // å¯¼å‡º Excelï¼ˆxlsxï¼‰
  function exportExcel(){
    // build table
    const data = employees.map(emp => {
      return {
        Empleado: emp.name || '',
        Dia1: emp.days[0]||0, Dia2: emp.days[1]||0, Dia3: emp.days[2]||0,
        Dia4: emp.days[3]||0, Dia5: emp.days[4]||0, Dia6: emp.days[5]||0,
        SinErrores: emp.noError ? 'SÃ­' : 'No',
        Equipo10: emp.teamExtra ? 'SÃ­' : 'No',
        BonoSemanal: calcEmployeeBono(emp)
      };
    });
    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Bonos');
    const week = document.getElementById('weekStart').value || '';
    const filename = week ? `bonos_${week}.xlsx` : 'bonos_semana.xlsx';
    XLSX.writeFile(wb, filename);
  }

  // XSS helper for values into HTML attributes
  function escapeHtml(s = '') {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  // ç»‘å®šé¡¶å±‚æŒ‰é’® & lifecycle
  document.addEventListener('DOMContentLoaded', () => {
    // load existing week
    const savedWeek = localStorage.getItem('picking_week') || '';
    if(savedWeek) $('#weekStart').value = savedWeek;

    // load data
    loadData();

    // ensure each employee has days array length 6
    employees = employees.map(e => ({ id: e.id || uid(), name: e.name||'', days: (e.days && e.days.length===6) ? e.days : [0,0,0,0,0,0], noError: typeof e.noError === 'boolean' ? e.noError : true, teamExtra: !!e.teamExtra }));

    // bind buttons
    $('#addBtn').addEventListener('click', () => {
      employees.push({ id: uid(), name:'', days:[0,0,0,0,0,0], noError:true, teamExtra:false });
      saveData();
      render();
      // focus last name input (improve UX)
      setTimeout(()=>{ const last = document.querySelectorAll('.emp-name'); if(last.length) last[last.length-1].focus(); },100);
    });
    $('#calcBtn').addEventListener('click', () => updateSummary());
    $('#exportBtn').addEventListener('click', exportExcel);
    $('#weekStart').addEventListener('change', updateWeekDisplay);

    // register service worker for offline (if available)
    if('serviceWorker' in navigator){
      try{ navigator.serviceWorker.register('/sw.js'); }catch(e){}
    }

    render();
  });

  // Expose render for service worker or testing
  window._renderPicking = render;
  </script>
</body>
</html>
